<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Bot Trading Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .header-gradient {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            transition: transform 0.2s;
        }
        
        .metric-value { font-size: 1.5rem; font-weight: 700; }
        
        /* Estilos para Badges de IA */
        .badge-decision-BUY { background-color: #198754; color: white; padding: 8px 12px; border-radius: 20px; box-shadow: 0 2px 5px rgba(25, 135, 84, 0.3); }
        .badge-decision-WAIT { background-color: #ffc107; color: #000; padding: 8px 12px; border-radius: 20px; }
        .badge-decision-NEUTRAL { background-color: #6c757d; color: white; padding: 8px 12px; border-radius: 20px; }
        
        /* Score Circle */
        .score-circle {
            width: 40px; height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
            border: 2px solid white;
        }
        
        /* Se√±ales T√©cnicas */
        .tech-tag {
            background-color: #eef2ff;
            color: #4f46e5;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            border: 1px solid #c7d2fe;
            display: inline-block;
            margin-top: 4px;
        }

        .rsi-badge {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .rsi-oversold { background-color: #d1e7dd; color: #0f5132; } /* < 30 */
        .rsi-neutral { background-color: #f8f9fa; color: #6c757d; }
    </style>
</head>
<body>

    <div class="header-gradient text-center">
        <div class="container">
            <h1><i class="fas fa-robot"></i> NT Market Analyzer</h1>
            <p class="opacity-75">Panel de Control de Oportunidades & IA</p>
            <div class="mt-3">
                <a href="/my-portfolio" class="btn btn-outline-light btn-sm mx-1"><i class="fas fa-wallet"></i> Portafolio</a>
                <a href="/history" class="btn btn-outline-light btn-sm mx-1"><i class="fas fa-history"></i> Historial</a>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card p-4 border-start border-4 border-primary">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="m-0"><i class="fas fa-bolt text-warning"></i> Ejecuci√≥n R√°pida</h4>
                        <span class="badge bg-light text-dark border">Saldo Virtual: $10,000 USD</span>
                    </div>
                    
                    <form id="buyForm" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Activo (Symbol)</label>
                            <input type="text" class="form-control" id="symbolInput" placeholder="Ej: BTC" readonly required style="background-color: #f8f9fa;">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Inversi√≥n (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="amountInput" value="100" min="10">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100 fw-bold shadow-sm">
                                <i class="fas fa-shopping-cart"></i> CONFIRMAR ORDEN
                            </button>
                        </div>
                    </form>
                    <div id="alertPlaceholder" class="mt-3"></div>
                </div>
            </div>
        </div>

        <h3 class="mb-3 text-secondary"><i class="fas fa-search-dollar"></i> Oportunidades Detectadas</h3>
        
        <div class="card p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Activo</th>
                            <th>Precio / Ca√≠da</th>
                            <th>RSI (14)</th>
                            <th style="width: 30%;">Se√±al T√©cnica</th>
                            <th>An√°lisis IA</th>
                            <th class="text-end pe-4">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for op in opportunities %}
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center me-3" style="width: 40px; height: 40px; font-weight: bold;">
                                        {{ op.symbol[:1] }}
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark">{{ op.symbol }}</div>
                                        <div class="text-muted small" style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            {{ op.name }}
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <td>
                                <div class="fw-bold">${{ "%.4f"|format(op.price) }}</div>
                                <div class="text-danger small fw-bold">
                                    <i class="fas fa-arrow-down"></i> {{ "%.2f"|format(op.percent_change) }}%
                                </div>
                            </td>

                            <td>
                                {% if op.rsi < 30 %}
                                    <span class="rsi-badge rsi-oversold">
                                        {{ "%.1f"|format(op.rsi) }} <i class="fas fa-check-circle small"></i>
                                    </span>
                                {% else %}
                                    <span class="rsi-badge rsi-neutral">
                                        {{ "%.1f"|format(op.rsi) }}
                                    </span>
                                {% endif %}
                            </td>

                            <td>
                                {% if op.technical_signal %}
                                    <div class="tech-tag">
                                        {{ op.technical_signal }}
                                    </div>
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>

                            <td>
                                <div class="d-flex align-items-center gap-2">
        {% if op.ai_score is not none %}
            <div class="score-circle shadow-sm" 
                 style="background-color: {% if op.ai_score >= 80 %}#198754{% elif op.ai_score >= 50 %}#ffc107{% else %}#dc3545{% endif %};">
                {{ op.ai_score }}
            </div>
        {% else %}
            <div class="score-circle shadow-sm" style="background-color: #6c757d;">
                ?
            </div>
        {% endif %}
        
        <div>
            {% if op.ai_decision %}
                <span class="badge-decision-{{ op.ai_decision }} small fw-bold">
                    {{ op.ai_decision }}
                </span>
            {% else %}
                <span class="badge bg-secondary small">Pendiente</span>
            {% endif %}

            {% if op.ai_reason %}
            <div class="text-muted small mt-1" style="font-size: 0.75rem; max-width: 200px; line-height: 1.2;">
                {{ op.ai_reason[:60] }}...
            </div>
            {% endif %}
        </div>
    </div>
                            </td>

                            <td class="text-end pe-4">
                                <button onclick="prefillBuy('{{ op.symbol }}')" class="btn btn-sm btn-outline-primary fw-bold">
                                    Comprar <i class="fas fa-arrow-up"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-search fa-3x mb-3"></i><br>
                                No se encontraron oportunidades con los filtros actuales.<br>
                                <small>Intenta ajustar el threshold en la URL (ej: ?threshold=-2)</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center mt-4 text-muted small">
            Datos provistos por TradingView & Google Gemini IA
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funci√≥n para "llevar" el s√≠mbolo de la tabla al formulario de arriba
        function prefillBuy(symbol) {
            document.getElementById('symbolInput').value = symbol;
            document.getElementById('symbolInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Efecto visual de "focus"
            const card = document.querySelector('.card');
            card.style.borderColor = '#0d6efd';
            setTimeout(() => card.style.borderColor = '', 1000);
        }

        // L√≥gica de Compra (AJAX)
        document.getElementById('buyForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const symbol = document.getElementById('symbolInput').value;
            const amount = document.getElementById('amountInput').value;
            const alertDiv = document.getElementById('alertPlaceholder');

            if (!symbol) {
                alertDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Por favor selecciona un activo de la tabla primero.</div>';
                return;
            }

            alertDiv.innerHTML = '<div class="alert alert-info">üöÄ Procesando orden con el Broker...</div>';

            try {
                const response = await fetch('/trade/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        symbol: symbol, 
                        investment_usd: parseFloat(amount) 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alertDiv.innerHTML = `
                        <div class="alert alert-success border-0 shadow-sm">
                            <h4><i class="fas fa-check-circle"></i> Orden Exitosa</h4>
                            <p class="mb-0">Has comprado <strong>${data.details}</strong></p>
                            <small>Verifica tu portafolio para m√°s detalles.</small>
                        </div>`;
                } else {
                    alertDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.detail || 'Algo sali√≥ mal'}</div>`;
                }

            } catch (error) {
                alertDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error de conexi√≥n con el servidor.</div>`;
            }
        });
    </script>
</body>
</html>